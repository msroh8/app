<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام التقارير الذكي | أ. محمد مجممي</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --p: #1e3a8a; --s: #3b82f6; --ok: #10b981; --warn: #f59e0b; --err: #ef4444; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        
        /* الهيدر */
        header { background: var(--p); color: white; padding: 15px; text-align: center; border-radius: 0 0 20px 20px; }
        .backup-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 0.7em; cursor: pointer; margin-top: 10px; }

        /* التنقل */
        .nav-sticky { position: sticky; top: 0; background: var(--bg); padding: 10px; z-index: 100; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        select { padding: 12px; border-radius: 12px; border: 2px solid #e2e8f0; font-weight: bold; background: white; font-size: 0.8em; }

        /* بطاقة الطالب في الرصد */
        .card { background: white; margin: 10px; border-radius: 15px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-right: 5px solid var(--p); }
        .card-h { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .style-tag { padding: 4px 10px; border-radius: 8px; font-size: 0.7em; font-weight: bold; cursor: pointer; border: 1px solid #ddd; }
        .st-none { background: #eee; } .st-visual { background: #dbeafe; color: #1e40af; } .st-auditory { background: #f3e8ff; color: #7e22ce; } .st-kinesthetic { background: #ffedd5; color: #c2410c; }

        /* أزرار الحضور والعدادات */
        .btn-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 10px; }
        .a-btn { padding: 8px; border-radius: 8px; border: 1px solid #eee; font-size: 0.8em; font-weight: bold; text-align: center; background: white; }
        .a-btn.active.P { background: var(--ok); color: white; } .a-btn.active.L { background: var(--warn); color: black; } .a-btn.active.A { background: var(--err); color: white; }
        
        .counter { display: flex; align-items: center; justify-content: space-between; background: #f1f5f9; padding: 8px; border-radius: 10px; margin-top: 5px; }
        .m-btn { width: 35px; height: 35px; border-radius: 8px; border: none; color: white; font-size: 1.2em; }

        /* شريط التنقل السفلي */
        .bottom-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 10px 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .tab { flex: 1; border: none; background: none; color: #94a3b8; font-size: 0.75em; font-weight: bold; }
        .tab.active { color: var(--s); }
        .tab i { font-size: 1.6em; display: block; margin-bottom: 4px; }

        /* صفحة التقارير */
        .report-section { display: none; padding: 15px; }
        .report-section.active { display: block; }
        .rep-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; color: white; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* تنسيق الطباعة والتقارير */
        #print-area { display: none; background: white; padding: 20px; }
        @media print {
            body * { display: none; }
            #print-area { display: block !important; width: 100%; }
            .page-break { page-break-after: always; }
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f1f5f9; }
    </style>
</head>
<body>

<header id="header">
    <h3 style="margin:0;">كشف المتابعة الإلكتروني</h3>
    <div style="font-size:0.8em; opacity:0.9;">أ/ محمد مجممي - م/ فهد القحطاني</div>
    <button class="backup-btn" onclick="exportJSON()"><i class="fas fa-save"></i> نسخة احتياطية (JSON)</button>
</header>

<div id="nav-tools" class="nav-sticky">
    <select id="cls"><option value="201">201</option><option value="202">202</option><option value="203">203</option></select>
    <select id="wk"></select>
    <select id="ls"><option value="1">حصة 1</option><option value="2">حصة 2</option><option value="3">حصة 3</option><option value="4">حصة 4</option></select>
</div>

<div id="track-page" class="report-section active">
    <div id="list"></div>
</div>

<div id="export-page" class="report-section">
    <button class="rep-btn" style="background: #1e293b;" onclick="genClassReport()">
        <i class="fas fa-table"></i> تصدير إحصاء الفصل (جدول)
    </button>
    <button class="rep-btn" style="background: #0891b2;" onclick="genAllCards()">
        <i class="fas fa-id-card"></i> تصدير جميع بطاقات الطلاب (جماعي)
    </button>
    <hr>
    <h4>تقارير فردية:</h4>
    <div id="ind-list"></div>
</div>

<div id="print-area"></div>

<nav id="bottom-nav" class="bottom-bar">
    <button class="tab active" onclick="showP('track', this)"><i class="fas fa-edit"></i>الرصد</button>
    <button class="tab" onclick="showP('export', this); renderIndList();"><i class="fas fa-file-export"></i>التصدير</button>
</nav>

<script>
    const names = {
        "201": ["أديب اكرم بن ابراهيم الخديدي","البراء رانى احمد السليماني","الوليد احمد بطي الزايدي","اياد حمزه خضر القرشي","باسل ياسر احمد هوساوى","حمزه عبدالرحمن امين نظيف","خالد ايمن محمد سعيد ششه","سطام فهد عايض الحارثي","شايق سامى مرزوق الطويرقي","طلال احمد مرزوق القرشي","طلال وجدي محمد الغريبي","عبدالعزيز فهد محمد الثمالي","عبدالكريم محمد عبدالكريم القرشي","عبدالله طلال ابن عبدالله المالكي","عبدالله عبدالهادي قليل الخديدي","عبدالله فهد عبدالله المالكي","عبدالمجيد عبدالله حميدان الحارثي","عبدالملك عمر صالح العتيبي","عزام عبدالله ابن سعيد الثبيتي","علي حسن صالح الفته","فهد عبدالملك ساعد النفيعي","فيصل عبدالبديع خلف الله القرشي","محمد حسن محمد الطويرقي","محمد خلف الله ابن سالم الشريف","مستور محمد مستور الحارثي","يزن محمد عبدالله الضويحي","يزيد ابن عبداللطيف ابن عمر الطلحي"],
        "202": ["احمد عبدالرزاق احمد المالكي","احمد عبده علي الشدادي","أسامة عويش محمد القرشي","الوليد خالد بخيت العتيبي","تميم عبدالرزاق احمد المالكي","تميم عبدالمنعم ابن محمد الاسمرى","حسن شاكر حسن شبيلي","سلطان علي سليم القرشي","سلطان ماجد عيد المالكي","عبدالعزيز احمد سلمان الدعجاني","عبدالله محمد عبدالله الحمياني","فهد ابراهيم فرحان الجعيد","فهد ماجد مسفر النفيعي","فهد هلال هليل الثبيتي","فيصل بندر بن فايت الحارثي","قصي محمد مشعل سوادي","محمد تركي ابن عمر الهذلي","محمد ماجد محمد ال ابراهيم","مراد عبدالرحيم محمدعلي الثبيتي","مشعل متعب عواض الجعيد","مهند عبدالرزاق احمد المالكي","مؤيد مرزوق عواض النفيعي","هاشم فهد وصل الله القرشي","وسام عبدالله احمد الفيفي","ياسر بن عبدالله بن عمر الحميدي","ياسر دخيل الله حمدان المالكي"],
        "203": ["أحمد عبدالله ابن عطيه الحصيني","أسامه فهد دخيل الله الزهراني","اصيل ايمن حمدان السريحى","البراء احمد عبدالله القرشي","ايمن خالد مستور الطويرقي","بتال رائد عبدالله الطويرقي","ثامر ابراهيم احمد الثمالي","راكان سعد عيد العصيمي","ريان ماجد ابن علي المالكي","سلطان عبدالحميد عبدالله آل حميدان","سهيل قاسم عبيدالله القرشي","سيف محمد معيش القرشي","طلال علي جمعان الزهراني","عبدالعزيز خلف الله مرزوق القرشي","عبدالعزيز سعود رجاء الحصيني","عبدالله عبدالرحمن دغش القحطاني","عبدالله عبدالعزيز عبيد الدهيسي","عبدالله علي جمعان الزهراني","عصام عواض بن صالح الخديدي","عناد محمد احمد مجرشي","فارس مشرف صالح المالكي","فيصل سليمان بادي الطويرقي","فيصل فهد حمود الطويرقي","مشعل سعد خالد الحارثي","هتان محمد جنيدب القرشي"]
    };

    let db = JSON.parse(localStorage.getItem('final_v3')) || {};
    
    // تهيئة القوائم
    const wkS = document.getElementById('wk');
    for(let i=1; i<=16; i++) wkS.innerHTML += `<option value="${i}">أسبوع ${i}</option>`;
    
    for(let c in names) {
        if(!db[c]) db[c] = names[c].map(n => ({ name: n, style: 'none', sessions: {} }));
    }

    function render() {
        const c = document.getElementById('cls').value;
        const w = wkS.value;
        const l = document.getElementById('ls').value;
        const key = `${w}_${l}`;
        const container = document.getElementById('list');
        container.innerHTML = '';

        db[c].forEach((s, idx) => {
            if(!s.sessions[key]) s.sessions[key] = { att:'', part:0, hw:0, int:0 };
            const cur = s.sessions[key];
            container.innerHTML += `
                <div class="card">
                    <div class="card-h">
                        <div style="font-weight:bold">${s.name}</div>
                        <div class="style-tag st-${s.style}" onclick="cycStyle('${c}',${idx})">${getS(s.style)}</div>
                    </div>
                    <div class="btn-group">
                        <button class="a-btn ${cur.att==='P'?'active':''} P" onclick="setA('${c}',${idx},'P')">حاضر</button>
                        <button class="a-btn ${cur.att==='L'?'active':''} L" onclick="setA('${c}',${idx},'L')">تأخر</button>
                        <button class="a-btn ${cur.att==='A'?'active':''} A" onclick="setA('${c}',${idx},'A')">غائب</button>
                    </div>
                    ${drawC(c, idx, 'part', 'مشاركة', cur.part)}
                    ${drawC(c, idx, 'hw', 'واجب', cur.hw)}
                    ${drawC(c, idx, 'int', 'تفاعل', cur.int)}
                </div>`;
        });
        save();
    }

    function drawC(c, idx, k, label, val) {
        return `<div class="counter"><span>${label}</span><div>
            <button class="m-btn" style="background:var(--err)" onclick="updVal('${c}',${idx},'${k}',-1)">-</button>
            <span style="margin:0 15px; font-weight:bold">${val}</span>
            <button class="m-btn" style="background:var(--ok)" onclick="updVal('${c}',${idx},'${k}',1)">+</button>
        </div></div>`;
    }

    function updVal(c, idx, k, d) {
        const key = `${wkS.value}_${document.getElementById('ls').value}`;
        db[c][idx].sessions[key][k] += d; render();
    }

    function cycStyle(c, idx) {
        const sts = ['none', 'visual', 'auditory', 'kinesthetic'];
        db[c][idx].style = sts[(sts.indexOf(db[c][idx].style)+1)%4]; render();
    }

    function getS(s) { return {none:'النمط', visual:'بصري', auditory:'سمعي', kinesthetic:'حركي'}[s]; }
    function setA(c, idx, v) {
        const key = `${wkS.value}_${document.getElementById('ls').value}`;
        db[c][idx].sessions[key].att = (db[c][idx].sessions[key].att === v) ? '' : v; render();
    }
    function save() { localStorage.setItem('final_v3', JSON.stringify(db)); }
    function showP(p, b) {
        document.querySelectorAll('.report-section').forEach(s => s.classList.remove('active'));
        document.getElementById(p + '-page').classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        b.classList.add('active'); window.scrollTo(0,0);
    }

    // تقارير الطباعة
    function genClassReport() {
        const c = document.getElementById('cls').value;
        let html = `<h2>تقرير إحصائي للفصل ${c}</h2><table><tr><th>الطالب</th><th>النمط</th><th>حضور</th><th>تأخر</th><th>غياب</th><th>نقاط</th></tr>`;
        db[c].forEach(s => {
            let p=0, l=0, a=0, pts=0;
            Object.values(s.sessions).forEach(v => {
                if(v.att==='P') p++; if(v.att==='L') l++; if(v.att==='A') a++;
                pts += (v.part + v.hw + v.int);
            });
            html += `<tr><td>${s.name}</td><td>${getS(s.style)}</td><td>${p}</td><td>${l}</td><td>${a}</td><td>${pts}</td></tr>`;
        });
        html += `</table><p>معلم المادة: محمد مجممي | مدير المدرسة: فهد القحطاني</p>`;
        doPrint(html);
    }

    function genSingleCard(idx) {
        const c = document.getElementById('cls').value;
        const s = db[c][idx];
        let p=0, l=0, a=0, part=0, hw=0, int=0;
        Object.values(s.sessions).forEach(v => {
            if(v.att==='P') p++; if(v.att==='L') l++; if(v.att==='A') a++;
            part+=v.part; hw+=v.hw; int+=v.int;
        });
        const html = `
            <div style="border:5px double var(--p); padding:30px; text-align:center;">
                <h3>بطاقة متابعة طالب</h3>
                <hr>
                <div style="text-align:right">
                    <p>اسم الطالب: <b>${s.name}</b></p>
                    <p>الفصل: <b>${c}</b> | النمط: <b>${getS(s.style)}</b></p>
                </div>
                <table>
                    <tr><th>المجال</th><th>الإحصائية التراكمية</th></tr>
                    <tr><td>الحضور</td><td>${p}</td></tr>
                    <tr><td>التأخر</td><td>${l}</td></tr>
                    <tr><td>الغياب</td><td>${a}</td></tr>
                    <tr><td>المشاركة والتفاعل</td><td>${part + int}</td></tr>
                    <tr><td>الواجبات</td><td>${hw}</td></tr>
                </table>
                <br><br>
                <div style="display:flex; justify-content:space-between">
                    <span>المعلم: محمد مجممي</span>
                    <span>المدير: فهد القحطاني</span>
                </div>
            </div>`;
        doPrint(html);
    }

    function genAllCards() {
        const c = document.getElementById('cls').value;
        let html = '';
        db[c].forEach((s, idx) => {
            let p=0, l=0, a=0, pts=0;
            Object.values(s.sessions).forEach(v => {
                if(v.att==='P') p++; if(v.att==='L') l++; if(v.att==='A') a++;
                pts += (v.part + v.hw + v.int);
            });
            html += `<div class="page-break" style="border:2px solid #000; padding:20px; margin-bottom:20px;">
                <h3 style="text-align:center">بطاقة أداء الطالب: ${s.name}</h3>
                <p>الفصل: ${c} | النمط: ${getS(s.style)}</p>
                <p>الحضور: ${p} | التأخر: ${l} | الغياب: ${a}</p>
                <p>إجمالي نقاط التميز: ${pts}</p>
                <p style="font-size:0.8em; text-align:left">توقيع المعلم: محمد مجممي</p>
            </div>`;
        });
        doPrint(html);
    }

    function doPrint(content) {
        const area = document.getElementById('print-area');
        area.innerHTML = content;
        window.print();
    }

    function renderIndList() {
        const c = document.getElementById('cls').value;
        const container = document.getElementById('ind-list');
        container.innerHTML = '';
        db[c].forEach((s, idx) => {
            container.innerHTML += `<button class="a-btn" style="width:100%; margin-bottom:5px; text-align:right" onclick="genSingleCard(${idx})">${s.name}</button>`;
        });
    }

    function exportJSON() {
        const blob = new Blob([JSON.stringify(db)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `backup_majmani_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    document.getElementById('cls').onchange = render;
    wkS.onchange = render;
    document.getElementById('ls').onchange = render;
    render();
</script>
</body>
</html>
