<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>كشف المتابعة الذكي | أ. محمد مجممي</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0f172a; --accent: #3b82f6; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --bg: #f1f5f9;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: #1e293b; }
        
        /* الهيدر ومركز النسخ الاحتياطي */
        header { 
            background: var(--primary); color: white; padding: 15px; 
            text-align: center; border-radius: 0 0 20px 20px;
        }
        .backup-zone {
            display: flex; justify-content: space-around; background: #1e293b;
            padding: 10px; margin-top: 10px; border-radius: 10px; font-size: 0.8em;
        }
        .btn-backup { background: #334155; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }

        /* التحكم */
        .sticky-nav { position: sticky; top: 0; background: var(--bg); padding: 10px; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        select { padding: 12px; border-radius: 12px; border: 1px solid #cbd5e1; font-weight: bold; background: white; font-size: 0.85em; }

        /* بطاقة الطالب */
        .s-card { background: white; margin: 12px; border-radius: 15px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .s-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .s-name { font-weight: 800; font-size: 0.95em; line-height: 1.4; flex: 1; }

        /* نمط التعلم - خلية واحدة تتبدل */
        .style-cell { 
            padding: 6px 12px; border-radius: 10px; font-size: 0.75em; font-weight: bold; 
            cursor: pointer; border: 2px solid transparent; min-width: 60px; text-align: center;
        }
        .st-none { background: #f8fafc; color: #94a3b8; border-color: #e2e8f0; }
        .st-visual { background: #eff6ff; color: #2563eb; border-color: #2563eb; }
        .st-auditory { background: #faf5ff; color: #9333ea; border-color: #9333ea; }
        .st-kinesthetic { background: #fff7ed; color: #ea580c; border-color: #ea580c; }

        /* الحضور */
        .att-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px; }
        .att-btn { padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; font-size: 0.8em; font-weight: bold; text-align: center; background: #fff; }
        .att-btn.active.P { background: var(--success); color: white; border-color: var(--success); }
        .att-btn.active.L { background: var(--warning); color: black; border-color: var(--warning); }
        .att-btn.active.A { background: var(--danger); color: white; border-color: var(--danger); }

        /* العدادات */
        .counter-row { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; margin-top: 5px; padding: 8px 12px; border-radius: 12px; }
        .btn-math { width: 38px; height: 38px; border-radius: 10px; border: none; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2em; }
        .btn-p { background: var(--success); }
        .btn-m { background: var(--danger); }
        .count-val { font-weight: 800; font-size: 1.1em; min-width: 25px; text-align: center; }

        /* التنقل السفلي */
        .b-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 12px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .nav-item { flex: 1; text-align: center; color: #94a3b8; font-size: 0.75em; border: none; background: none; font-weight: bold; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 1.8em; display: block; margin-bottom: 4px; }

        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; font-size: 1.1em;">نظام المتابعة - أ/ محمد مجممي</div>
    <div style="font-size: 0.8em; opacity: 0.8;">المدير: فهد القحطاني | عام 2026</div>
    
    <div class="backup-zone">
        <button class="btn-backup" onclick="exportData()"><i class="fas fa-file-export"></i> تصدير نسخة</button>
        <button class="btn-backup" onclick="document.getElementById('fileInput').click()"><i class="fas fa-file-import"></i> استيراد نسخة</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(event)">
    </div>
</header>

<div class="sticky-nav">
    <div class="grid-3">
        <select id="classSel" onchange="render()"></select>
        <select id="weekSel" onchange="render()"></select>
        <select id="sessionSel" onchange="render()">
            <option value="1">حصة 1</option>
            <option value="2">حصة 2</option>
            <option value="3">حصة 3</option>
            <option value="4">حصة 4</option>
        </select>
    </div>
</div>

<div id="track-page" class="page active">
    <div id="studentsList"></div>
</div>

<div id="stats-page" class="page" style="padding: 10px;">
    <div class="s-card" style="text-align: center;">
        <h4>انضباط الفصل (تراكمي)</h4>
        <canvas id="classChart"></canvas>
    </div>
    <div id="indStats"></div>
</div>

<nav class="b-nav">
    <button class="nav-item active" onclick="showPage('track', this)"><i class="fas fa-tasks"></i>الرصد</button>
    <button class="nav-item" onclick="showPage('stats', this); updateStats();"><i class="fas fa-chart-bar"></i>التقارير</button>
</nav>

<script>
    const studentNames = {
        "201": ["أديب اكرم بن ابراهيم الخديدي","البراء رانى احمد السليماني","الوليد احمد بطي الزايدي","اياد حمزه خضر القرشي","باسل ياسر احمد هوساوى","حمزه عبدالرحمن امين نظيف","خالد ايمن محمد سعيد ششه","سطام فهد عايض الحارثي","شايق سامى مرزوق الطويرقي","طلال احمد مرزوق القرشي","طلال وجدي محمد الغريبي","عبدالعزيز فهد محمد الثمالي","عبدالكريم محمد عبدالكريم القرشي","عبدالله طلال ابن عبدالله المالكي","عبدالله عبدالهادي قليل الخديدي","عبدالله فهد عبدالله المالكي","عبدالمجيد عبدالله حميدان الحارثي","عبدالملك عمر صالح العتيبي","عزام عبدالله ابن سعيد الثبيتي","علي حسن صالح الفته","فهد عبدالملك ساعد النفيعي","فيصل عبدالبديع خلف الله القرشي","محمد حسن محمد الطويرقي","محمد خلف الله ابن سالم الشريف","مستور محمد مستور الحارثي","يزن محمد عبدالله الضويحي","يزيد ابن عبداللطيف ابن عمر الطلحي"],
        "202": ["احمد عبدالرزاق احمد المالكي","احمد عبده علي الشدادي","أسامة عويش محمد القرشي","الوليد خالد بخيت العتيبي","تميم عبدالرزاق احمد المالكي","تميم عبدالمنعم ابن محمد الاسمرى","حسن شاكر حسن شبيلي","سلطان علي سليم القرشي","سلطان ماجد عيد المالكي","عبدالعزيز احمد سلمان الدعجاني","عبدالله محمد عبدالله الحمياني","فهد ابراهيم فرحان الجعيد","فهد ماجد مسفر النفيعي","فهد هلال هليل الثبيتي","فيصل بندر بن فايت الحارثي","قصي محمد مشعل سوادي","محمد تركي ابن عمر الهذلي","محمد ماجد محمد ال ابراهيم","مراد عبدالرحيم محمدعلي الثبيتي","مشعل متعب عواض الجعيد","مهند عبدالرزاق احمد المالكي","مؤيد مرزوق عواض النفيعي","هاشم فهد وصل الله القرشي","وسام عبدالله احمد الفيفي","ياسر بن عبدالله بن عمر الحميدي","ياسر دخيل الله حمدان المالكي"],
        "203": ["أحمد عبدالله ابن عطيه الحصيني","أسامه فهد دخيل الله الزهراني","اصيل ايمن حمدان السريحى","البراء احمد عبدالله القرشي","ايمن خالد مستور الطويرقي","بتال رائد عبدالله الطويرقي","ثامر ابراهيم احمد الثمالي","راكان سعد عيد العصيمي","ريان ماجد ابن علي المالكي","سلطان عبدالحميد عبدالله آل حميدان","سهيل قاسم عبيدالله القرشي","سيف محمد معيش القرشي","طلال علي جمعان الزهراني","عبدالعزيز خلف الله مرزوق القرشي","عبدالعزيز سعود رجاء الحصيني","عبدالله عبدالرحمن دغش القحطاني","عبدالله عبدالعزيز عبيد الدهيسي","عبدالله علي جمعان الزهراني","عصام عواض بن صالح الخديدي","عناد محمد احمد مجرشي","فارس مشرف صالح المالكي","فيصل سليمان بادي الطويرقي","فيصل فهد حمود الطويرقي","مشعل سعد خالد الحارثي","هتان محمد جنيدب القرشي"]
    };

    let db = JSON.parse(localStorage.getItem('teacher_db_2026_pro')) || {};

    const classSel = document.getElementById('classSel');
    for(let c in studentNames) {
        classSel.innerHTML += `<option value="${c}">فصل ${c}</option>`;
        if(!db[c]) db[c] = studentNames[c].map(n => ({ name: n, style: 'none', data: {} }));
    }

    const weekSel = document.getElementById('weekSel');
    for(let i=1; i<=16; i++) weekSel.innerHTML += `<option value="${i}">أسبوع ${i}</option>`;

    function render() {
        const cls = classSel.value;
        const wk = weekSel.value;
        const ses = document.getElementById('sessionSel').value;
        const key = `${wk}_${ses}`;
        const list = document.getElementById('studentsList');
        list.innerHTML = '';

        db[cls].forEach((s, idx) => {
            if(!s.data[key]) s.data[key] = { att:'', part:0, hw:0, int:0 };
            const d = s.data[key];

            const card = document.createElement('div');
            card.className = 's-card';
            card.innerHTML = `
                <div class="s-header">
                    <div class="s-name">${s.name}</div>
                    <div class="style-cell st-${s.style}" onclick="toggleStyle('${cls}',${idx})">${getStyleAr(s.style)}</div>
                </div>
                <div class="att-row">
                    <div class="att-btn P ${d.att==='P'?'active':''}" onclick="setAtt('${cls}',${idx},'P')">حاضر</div>
                    <div class="att-btn L ${d.att==='L'?'active':''}" onclick="setAtt('${cls}',${idx},'L')">تأخر</div>
                    <div class="att-btn A ${d.att==='A'?'active':''}" onclick="setAtt('${cls}',${idx},'A')">غائب</div>
                </div>
                ${createCounter(cls, idx, 'part', 'المشاركة', d.part)}
                ${createCounter(cls, idx, 'hw', 'الواجبات', d.hw)}
                ${createCounter(cls, idx, 'int', 'التفاعل', d.int)}
            `;
            list.appendChild(card);
        });
    }

    function createCounter(cls, idx, key, label, val) {
        return `
            <div class="counter-row">
                <span style="font-size:0.85em; font-weight:bold;">${label}</span>
                <div style="display:flex; align-items:center; gap:12px;">
                    <button class="btn-math btn-m" onclick="updateVal('${cls}',${idx},'${key}',-1)"><i class="fas fa-minus"></i></button>
                    <span class="count-val">${val}</span>
                    <button class="btn-math btn-p" onclick="updateVal('${cls}',${idx},'${key}',1)"><i class="fas fa-plus"></i></button>
                </div>
            </div>`;
    }

    function updateVal(cls, idx, key, delta) {
        const sessionKey = `${weekSel.value}_${document.getElementById('sessionSel').value}`;
        db[cls][idx].data[sessionKey][key] += delta;
        save(); render();
    }

    function toggleStyle(cls, idx) {
        const sts = ['none', 'visual', 'auditory', 'kinesthetic'];
        db[cls][idx].style = sts[(sts.indexOf(db[cls][idx].style)+1)%4];
        save(); render();
    }

    function getStyleAr(s) { return { none:'النمط', visual:'بصري', auditory:'سمعي', kinesthetic:'حركي' }[s]; }

    function setAtt(cls, idx, v) {
        const sessionKey = `${weekSel.value}_${document.getElementById('sessionSel').value}`;
        db[cls][idx].data[sessionKey].att = (db[cls][idx].data[sessionKey].att === v) ? '' : v;
        save(); render();
    }

    function save() { localStorage.setItem('teacher_db_2026_pro', JSON.stringify(db)); }

    function exportData() {
        const dataStr = JSON.stringify(db);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_kashf_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                db = imported;
                save(); render();
                alert("تم استيراد البيانات بنجاح!");
            } catch (err) { alert("ملف غير صالح!"); }
        };
        reader.readAsText(file);
    }

    function showPage(p, btn) {
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
        document.getElementById(p + '-page').classList.add('active');
        document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        window.scrollTo(0,0);
    }

    let myChart;
    function updateStats() {
        const cls = classSel.value;
        const area = document.getElementById('indStats');
        area.innerHTML = '';
        let total = { P:0, L:0, A:0 };

        db[cls].forEach(s => {
            let sum = { p:0, l:0, a:0, pts:0 };
            Object.values(s.data).forEach(v => {
                if(v.att==='P') sum.p++; if(v.att==='L') sum.l++; if(v.att==='A') sum.a++;
                sum.pts += (v.part + v.hw + v.int);
            });
            total.P += sum.p; total.L += sum.l; total.A += sum.a;
            area.innerHTML += `
                <div class="s-card">
                    <strong>${s.name}</strong>
                    <div style="display:grid; grid-template-columns: repeat(4,1fr); gap:5px; margin-top:10px; text-align:center; font-size:0.7em;">
                        <div style="background:#dcfce7; padding:5px; border-radius:5px">ح:${sum.p}</div>
                        <div style="background:#fef3c7; padding:5px; border-radius:5px">ت:${sum.l}</div>
                        <div style="background:#fee2e2; padding:5px; border-radius:5px">غ:${sum.a}</div>
                        <div style="background:#dbeafe; padding:5px; border-radius:5px">نقاط:${sum.pts}</div>
                    </div>
                </div>`;
        });

        const ctx = document.getElementById('classChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['حاضر', 'متأخر', 'غائب'],
                datasets: [{ data: [total.P, total.L, total.A], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'] }]
            }
        });
    }

    render();
</script>
</body>
</html>
