<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3a8a">
    <title>المتابعة الذكي - أ/ محمد مجممي</title>
    <!-- استدعاء المكتبات -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #1e3a8a;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        /* --- أساسيات الصفحة --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 100px; /* مسافة للتنقل السفلي */
            overscroll-behavior-y: none;
        }

        /* --- الرأس ومنطقة البيانات --- */
        header {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            color: white;
            padding: 20px 15px;
            text-align: center;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .app-title { margin: 0; font-size: 1.2rem; font-weight: 800; }
        .app-subtitle { font-size: 0.8rem; opacity: 0.9; margin-top: 5px; }

        /* تنبيه الآيفون */
        .ios-warning {
            background: #fff7ed;
            border: 1px solid #fdba74;
            color: #9a3412;
            padding: 12px;
            margin: 15px auto;
            border-radius: 10px;
            font-size: 0.85rem;
            line-height: 1.5;
            width: 95%;
            display: none; /* يظهر بالجافاسكربت */
        }

        /* أزرار التحكم بالملفات */
        .data-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 95%;
            margin: 15px auto 0;
        }

        .btn-file {
            padding: 12px;
            border-radius: 10px;
            border: none;
            color: white;
            font-weight: bold;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-save { background: #059669; }
        .btn-load { background: #2563eb; }
        .btn-reset { 
            grid-column: span 2; 
            background: #ef4444; 
            margin-top: 5px;
            font-size: 0.75rem;
            padding: 8px;
        }

        /* --- شريط الفلاتر --- */
        .filters-bar {
            position: sticky;
            top: 0;
            background: rgba(243, 244, 246, 0.95);
            backdrop-filter: blur(8px);
            padding: 10px;
            z-index: 50;
            display: grid;
            grid-template-columns: 1.2fr 1fr 0.8fr;
            gap: 8px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            color: var(--primary);
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* --- بطاقة الطالب --- */
        .student-card {
            background: var(--card-bg);
            margin: 12px 10px;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-right: 5px solid var(--primary);
            transition: transform 0.1s;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .student-name { font-weight: 800; font-size: 1rem; color: #111827; }

        .learning-style {
            display: inline-block;
            padding: 4px 8px;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #4b5563;
            cursor: pointer;
            margin-top: 5px;
        }
        .st-visual { background: #dbeafe; color: #1e40af; }
        .st-auditory { background: #f3e8ff; color: #7e22ce; }
        .st-kinesthetic { background: #ffedd5; color: #9a3412; }

        /* أزرار التحضير */
        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .att-btn {
            padding: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            color: #6b7280;
            font-weight: bold;
            cursor: pointer;
        }

        .att-btn.active.P { background: var(--success); color: white; border-color: var(--success); }
        .att-btn.active.L { background: var(--warning); color: black; border-color: var(--warning); }
        .att-btn.active.A { background: var(--danger); color: white; border-color: var(--danger); }

        /* العدادات (المشاركة، الواجبات...) */
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
            padding: 8px 10px;
            margin-bottom: 6px;
            border-radius: 8px;
            border: 1px solid #f3f4f6;
        }
        
        .counter-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            color: white;
        }
        .btn-minus { background: #d1d5db; color: #374151; }
        .btn-plus { background: var(--success); }
        .count-val { font-weight: 800; width: 20px; text-align: center; }

        /* --- التنقل السفلي --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 20px;
            z-index: 100;
        }

        .nav-item {
            border: none;
            background: transparent;
            color: #9ca3af;
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.4rem; }

        /* --- الصفحات --- */
        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- شارة عدم الحفظ --- */
        .unsaved-badge {
            position: fixed;
            top: 15px;
            left: 15px;
            background: #ef4444;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 200;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- الطباعة --- */
        @media print {
            body { background: white; padding: 0; }
            header, .filters-bar, .bottom-nav, .data-controls, .ios-warning, .unsaved-badge { display: none !important; }
            .page-content { display: none !important; }
            #print-container { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; direction: rtl; }
            th, td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 12pt; }
            .print-page { page-break-after: always; padding: 20px; text-align: center; border: 2px solid #000; margin-bottom: 20px; }
        }
        #print-container { display: none; }

        /* --- Modal (النافذة المنبثقة) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 300;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; width: 90%; max-height: 85vh;
            border-radius: 15px; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column;
        }
    </style>
</head>
<body>

<!-- الرأس -->
<header>
    <h1 class="app-title">تطبيق المتابعة الذكي</h1>
    <div class="app-subtitle">أ/ محمد مجممي | 1447 هـ</div>
    
    <div id="ios-alert" class="ios-warning">
        <i class="fas fa-exclamation-triangle"></i> <b>تنبيه هام للآيفون:</b><br>
        لتجنب فقدان البيانات، اضغط "حفظ في ملف" عند الانتهاء. وعند العودة، اضغط "استرجاع من ملف".
    </div>

    <div class="data-controls">
        <button class="btn-file btn-save" onclick="exportData()">
            <i class="fas fa-download"></i> حفظ في ملف
        </button>
        <button class="btn-file btn-load" onclick="document.getElementById('importFile').click()">
            <i class="fas fa-upload"></i> استرجاع من ملف
        </button>
        <button class="btn-file btn-reset" onclick="resetData()">
            <i class="fas fa-trash"></i> تصفير جميع البيانات (إعادة ضبط)
        </button>
        <input type="file" id="importFile" style="display: none;" onchange="importData(this)">
    </div>
</header>

<div id="unsaved-msg" class="unsaved-badge">! توجد تغييرات غير محفوظة</div>

<!-- شريط التصفية -->
<div class="filters-bar">
    <select id="classSelect" onchange="render()"></select>
    <select id="weekSelect" onchange="render()"></select>
    <select id="sessionSelect" onchange="render()">
        <option value="1">حصة 1</option>
        <option value="2">حصة 2</option>
        <option value="3">حصة 3</option>
        <option value="4">حصة 4</option>
        <option value="5">حصة 5</option>
        <option value="6">حصة 6</option>
    </select>
</div>

<!-- صفحة الرصد -->
<div id="page-track" class="page-content active">
    <div id="students-container"></div>
</div>

<!-- صفحة التقارير -->
<div id="page-reports" class="page-content">
    <div style="text-align: center; background: white; margin: 15px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <h3 style="margin-top:0">إحصائيات الفصل</h3>
        <div style="width: 200px; margin: 0 auto;">
            <canvas id="statsChart"></canvas>
        </div>
    </div>

    <div style="padding: 0 15px;">
        <button class="btn-file" style="width:100%; background:#1f2937; margin-bottom:10px" onclick="showClassReport()">
            <i class="fas fa-table"></i> عرض كشف الدرجات الشامل
        </button>
        <button class="btn-file" style="width:100%; background:#0891b2; margin-bottom:20px" onclick="printAllCards()">
            <i class="fas fa-print"></i> طباعة بطاقات الكل
        </button>
        
        <h4 style="margin-bottom: 10px;">تقارير فردية:</h4>
        <div id="individual-reports-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;"></div>
    </div>
</div>

<!-- القائمة السفلية -->
<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchPage('track', this)">
        <i class="fas fa-user-check"></i>
        <span>الرصد</span>
    </button>
    <button class="nav-item" onclick="switchPage('reports', this)">
        <i class="fas fa-chart-pie"></i>
        <span>التقارير</span>
    </button>
</nav>

<!-- نافذة العرض (Modal) -->
<div id="mainModal" class="modal-overlay">
    <div class="modal-box">
        <div id="modalContent"></div>
        <div style="margin-top: auto; display: flex; gap: 10px; padding-top: 15px;">
            <button class="btn-file" style="flex:1; background:#ef4444;" onclick="closeModal()">إغلاق</button>
            <button class="btn-file" style="flex:1; background:#1e3a8a;" onclick="printModalContent()">طباعة</button>
        </div>
    </div>
</div>

<!-- حاوية الطباعة -->
<div id="print-container"></div>

<script>
    // --- البيانات الأساسية ---
    const CLASS_LIST = {
        "201": ["أديب اكرم بن ابراهيم الخديدي","البراء رانى احمد السليماني","الوليد احمد بطي الزايدي","اياد حمزه خضر القرشي","باسل ياسر احمد هوساوى","حمزه عبدالرحمن امين نظيف","خالد ايمن محمد سعيد ششه","سطام فهد عايض الحارثي","شايق سامى مرزوق الطويرقي","طلال احمد مرزوق القرشي","طلال وجدي محمد الغريبي","عبدالعزيز فهد محمد الثمالي","عبدالكريم محمد عبدالكريم القرشي","عبدالله طلال ابن عبدالله المالكي","عبدالله عبدالهادي قليل الخديدي","عبدالله فهد عبدالله المالكي","عبدالمجيد عبدالله حميدان الحارثي","عبدالملك عمر صالح العتيبي","عزام عبدالله ابن سعيد الثبيتي","علي حسن صالح الفته","فهد عبدالملك ساعد النفيعي","فيصل عبدالبديع خلف الله القرشي","محمد حسن محمد الطويرقي","محمد خلف الله ابن سالم الشريف","مستور محمد مستور الحارثي","يزن محمد عبدالله الضويحي","يزيد ابن عبداللطيف ابن عمر الطلحي"],
        "202": ["احمد عبدالرزاق احمد المالكي","احمد عبده علي الشدادي","أسامة عويش محمد القرشي","الوليد خالد بخيت العتيبي","تميم عبدالرزاق احمد المالكي","تميم عبدالمنعم ابن محمد الاسمرى","حسن شاكر حسن شبيلي","سلطان علي سليم القرشي","سلطان ماجد عيد المالكي","عبدالعزيز احمد سلمان الدعجاني","عبدالله محمد عبدالله الحمياني","فهد ابراهيم فرحان الجعيد","فهد ماجد مسفر النفيعي","فهد هلال هليل الثبيتي","فيصل بندر بن فايت الحارثي","قصي محمد مشعل سوادي","محمد تركي ابن عمر الهذلي","محمد ماجد محمد ال ابراهيم","مراد عبدالرحيم محمدعلي الثبيتي","مشعل متعب عواض الجعيد","مهند عبدالرزاق احمد المالكي","مؤيد مرزوق عواض النفيعي","هاشم فهد وصل الله القرشي","وسام عبدالله احمد الفيفي","ياسر بن عبدالله بن عمر الحميدي","ياسر دخيل الله حمدان المالكي"],
        "203": ["أحمد عبدالله ابن عطيه الحصيني","أسامه فهد دخيل الله الزهراني","اصيل ايمن حمدان السريحى","البراء احمد عبدالله القرشي","ايمن خالد مستور الطويرقي","بتال رائد عبدالله الطويرقي","ثامر ابراهيم احمد الثمالي","راكان سعد عيد العصيمي","ريان ماجد ابن علي المالكي","سلطان عبدالحميد عبدالله آل حميدان","سهيل قاسم عبيدالله القرشي","سيف محمد معيش القرشي","طلال علي جمعان الزهراني","عبدالعزيز خلف الله مرزوق القرشي","عبدالعزيز سعود رجاء الحصيني","عبدالله عبدالرحمن دغش القحطاني","عبدالله عبدالعزيز عبيد الدهيسي","عبدالله علي جمعان الزهراني","عصام عواض بن صالح الخديدي","عناد محمد احمد مجرشي","فارس مشرف صالح المالكي","فيصل سليمان بادي الطويرقي","فيصل فهد حمود الطويرقي","مشعل سعد خالد الحارثي","هتان محمد جنيدب القرشي"]
    };

    let db = {};
    let chartInstance = null;

    // --- التهيئة عند التشغيل ---
    window.onload = function() {
        // فحص الآيفون
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if(isIOS) document.getElementById('ios-alert').style.display = 'block';

        // تعبئة القوائم
        const wSel = document.getElementById('weekSelect');
        const cSel = document.getElementById('classSelect');
        
        for(let i=1; i<=13; i++) wSel.innerHTML += `<option value="${i}">الأسبوع ${i}</option>`;
        for(let c in CLASS_LIST) cSel.innerHTML += `<option value="${c}">فصل ${c}</option>`;

        // تحميل البيانات
        loadFromStorage();
        render();
    };

    // --- إدارة البيانات ---
    function initNewDB() {
        let newDB = {};
        for(let c in CLASS_LIST) {
            newDB[c] = CLASS_LIST[c].map(name => ({
                name: name,
                style: 'none', // none, visual, auditory, kinesthetic
                sessions: {} // key: "week_session" -> { att: '', part: 0, hw: 0, int: 0 }
            }));
        }
        return newDB;
    }

    function loadFromStorage() {
        try {
            const saved = localStorage.getItem('edu_tracker_v3');
            if(saved) {
                db = JSON.parse(saved);
                // تحقق بسيط من صحة البيانات
                if(!db["201"]) throw new Error("بيانات تالفة");
            } else {
                db = initNewDB();
            }
        } catch(e) {
            console.error("خطأ في التحميل", e);
            db = initNewDB();
        }
    }

    function saveToStorage() {
        try {
            localStorage.setItem('edu_tracker_v3', JSON.stringify(db));
            document.getElementById('unsaved-msg').style.display = 'block';
        } catch(e) {
            alert("تنبيه: الذاكرة ممتلئة أو محظورة.");
        }
    }

    // --- دوال العرض والمنطق (Render Logic) ---
    function render() {
        const classId = document.getElementById('classSelect').value;
        const weekId = document.getElementById('weekSelect').value;
        const sessId = document.getElementById('sessionSelect').value;
        const sessionKey = `${weekId}_${sessId}`;

        const container = document.getElementById('students-container');
        container.innerHTML = '';

        if (!db[classId]) { 
            container.innerHTML = '<p style="text-align:center">لا توجد بيانات لهذا الفصل.</p>'; 
            return; 
        }

        db[classId].forEach((student, index) => {
            // ضمان وجود سجل للحصة
            if (!student.sessions[sessionKey]) {
                student.sessions[sessionKey] = { att: '', part: 0, hw: 0, int: 0 };
            }
            const current = student.sessions[sessionKey];

            // تحضير نصوص الأنماط
            let styleText = 'تحديد النمط';
            let styleClass = '';
            let styleIcon = 'fa-circle-question';
            if (student.style === 'visual') { styleText = 'بصري'; styleClass = 'st-visual'; styleIcon = 'fa-eye'; }
            else if (student.style === 'auditory') { styleText = 'سمعي'; styleClass = 'st-auditory'; styleIcon = 'fa-ear-listen'; }
            else if (student.style === 'kinesthetic') { styleText = 'حركي'; styleClass = 'st-kinesthetic'; styleIcon = 'fa-person-running'; }

            const html = `
            <div class="student-card">
                <div class="card-header">
                    <div>
                        <div class="student-name">${student.name}</div>
                        <div class="learning-style ${styleClass}" onclick="toggleStyle('${classId}', ${index})">
                            <i class="fas ${styleIcon}"></i> ${styleText}
                        </div>
                    </div>
                </div>

                <div class="attendance-grid">
                    <button class="att-btn ${current.att === 'P' ? 'active P' : ''}" onclick="setAttendance('${classId}', ${index}, 'P')">حاضر</button>
                    <button class="att-btn ${current.att === 'L' ? 'active L' : ''}" onclick="setAttendance('${classId}', ${index}, 'L')">تأخر</button>
                    <button class="att-btn ${current.att === 'A' ? 'active A' : ''}" onclick="setAttendance('${classId}', ${index}, 'A')">غائب</button>
                </div>

                ${renderMetric(classId, index, 'part', 'المشاركة', current.part)}
                ${renderMetric(classId, index, 'hw', 'الواجبات', current.hw)}
                ${renderMetric(classId, index, 'int', 'التفاعل', current.int)}
            </div>
            `;
            container.innerHTML += html;
        });
    }

    function renderMetric(c, i, key, label, val) {
        return `
        <div class="metric-row">
            <span style="font-weight:600; font-size:0.9rem">${label}</span>
            <div class="counter-controls">
                <button class="btn-circle btn-minus" onclick="updateCount('${c}', ${i}, '${key}', -1)">-</button>
                <span class="count-val">${val}</span>
                <button class="btn-circle btn-plus" onclick="updateCount('${c}', ${i}, '${key}', 1)">+</button>
            </div>
        </div>`;
    }

    // --- تحديث البيانات ---
    function updateCount(c, i, key, delta) {
        const sessionKey = `${document.getElementById('weekSelect').value}_${document.getElementById('sessionSelect').value}`;
        const val = db[c][i].sessions[sessionKey][key];
        if (val + delta >= 0) {
            db[c][i].sessions[sessionKey][key] += delta;
            saveToStorage();
            render();
        }
    }

    function setAttendance(c, i, status) {
        const sessionKey = `${document.getElementById('weekSelect').value}_${document.getElementById('sessionSelect').value}`;
        const current = db[c][i].sessions[sessionKey].att;
        db[c][i].sessions[sessionKey].att = (current === status) ? '' : status;
        saveToStorage();
        render();
    }

    function toggleStyle(c, i) {
        const styles = ['none', 'visual', 'auditory', 'kinesthetic'];
        const currentIdx = styles.indexOf(db[c][i].style);
        db[c][i].style = styles[(currentIdx + 1) % styles.length];
        saveToStorage();
        render();
    }

    // --- الاستيراد والتصدير (لحل مشكلة الآيفون) ---
    function exportData() {
        const dataStr = JSON.stringify(db);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const date = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = `بيانات_المتابعة_${date}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // إخفاء رسالة عدم الحفظ
        document.getElementById('unsaved-msg').style.display = 'none';
        alert("تم إنشاء ملف النسخة الاحتياطية. يرجى حفظه في 'الملفات' على الآيفون.");
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loadedDB = JSON.parse(e.target.result);
                // تحقق بسيط
                if(loadedDB["201"]) {
                    db = loadedDB;
                    saveToStorage();
                    render();
                    alert("تم استرجاع البيانات بنجاح!");
                    document.getElementById('unsaved-msg').style.display = 'none';
                } else {
                    alert("الملف لا يحتوي على بيانات صحيحة.");
                }
            } catch(err) {
                alert("حدث خطأ أثناء قراءة الملف.");
            }
        };
        reader.readAsText(file);
    }

    function resetData() {
        if(confirm("تحذير: سيتم حذف جميع البيانات والبدء من جديد. هل أنت متأكد؟")) {
            db = initNewDB();
            saveToStorage();
            render();
            alert("تم تصفير البيانات.");
        }
    }

    // --- التنقل بين الصفحات ---
    function switchPage(pageName, btn) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageName).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        if (pageName === 'reports') {
            updateReportsUI();
        }
        window.scrollTo(0, 0);
    }

    // --- التقارير والإحصائيات ---
    function getStudentSummary(student) {
        let s = { p: 0, l: 0, a: 0, points: 0 };
        Object.values(student.sessions).forEach(sess => {
            if (sess.att === 'P') s.p++;
            if (sess.att === 'L') s.l++;
            if (sess.att === 'A') s.a++;
            s.points += (sess.part || 0) + (sess.hw || 0) + (sess.int || 0);
        });
        return s;
    }

    function updateReportsUI() {
        const classId = document.getElementById('classSelect').value;
        const students = db[classId];
        let totals = { p: 0, l: 0, a: 0 };

        const listDiv = document.getElementById('individual-reports-list');
        listDiv.innerHTML = '';

        students.forEach((st, idx) => {
            const sum = getStudentSummary(st);
            totals.p += sum.p;
            totals.l += sum.l;
            totals.a += sum.a;

            listDiv.innerHTML += `
            <button class="att-btn" onclick="showStudentCard('${classId}', ${idx})">
                ${st.name}
            </button>`;
        });

        // رسم الشارت
        const ctx = document.getElementById('statsChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['حضور', 'تأخر', 'غياب'],
                datasets: [{
                    data: [totals.p, totals.l, totals.a],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // --- عرض التقارير (Modals) ---
    function showModal(content) {
        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('mainModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('mainModal').style.display = 'none';
    }

    function printModalContent() {
        document.getElementById('print-container').innerHTML = document.getElementById('modalContent').innerHTML;
        window.print();
    }

    function showClassReport() {
        const c = document.getElementById('classSelect').value;
        let html = `
            <h2 style="text-align:center">تقرير شامل - فصل ${c}</h2>
            <table>
                <tr style="background:#eee"><th>الاسم</th><th>حضور</th><th>تأخر</th><th>غياب</th><th>النقاط</th></tr>
        `;
        db[c].forEach(st => {
            const sum = getStudentSummary(st);
            html += `<tr>
                <td style="text-align:right">${st.name}</td>
                <td>${sum.p}</td><td>${sum.l}</td><td>${sum.a}</td>
                <td>${sum.points}</td>
            </tr>`;
        });
        html += `</table>`;
        showModal(html);
    }

    function showStudentCard(c, idx) {
        const st = db[c][idx];
        const sum = getStudentSummary(st);
        const styleMap = {none:'غير محدد', visual:'بصري', auditory:'سمعي', kinesthetic:'حركي'};
        
        const html = `
            <div class="print-page" style="border: 4px double #1e3a8a; padding: 20px; text-align: center;">
                <h3>بطاقة متابعة طالب</h3>
                <h2 style="color:#1e3a8a">${st.name}</h2>
                <p>الفصل: ${c} | نمط التعلم: ${styleMap[st.style]}</p>
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid #ddd;">
                <table style="width:100%">
                    <tr><th>المعيار</th><th>النتيجة</th></tr>
                    <tr><td>أيام الحضور</td><td>${sum.p}</td></tr>
                    <tr><td>أيام التأخر</td><td>${sum.l}</td></tr>
                    <tr><td>أيام الغياب</td><td>${sum.a}</td></tr>
                    <tr style="background:#f0f9ff"><td><strong>مجموع النقاط</strong></td><td><strong>${sum.points}</strong></td></tr>
                </table>
                <div style="margin-top: 30px; display:flex; justify-content:space-between">
                    <span>المعلم: محمد مجممي</span>
                    <span>المدير: فهد القحطاني</span>
                </div>
            </div>
        `;
        showModal(html);
    }

    function printAllCards() {
        const c = document.getElementById('classSelect').value;
        let html = '';
        db[c].forEach(st => {
            const sum = getStudentSummary(st);
            html += `
            <div class="print-page">
                <h3>${st.name}</h3>
                <p>فصل: ${c}</p>
                <table>
                    <tr><th>حضور</th><th>تأخر</th><th>غياب</th><th>نقاط</th></tr>
                    <tr><td>${sum.p}</td><td>${sum.l}</td><td>${sum.a}</td><td>${sum.points}</td></tr>
                </table>
            </div>`;
        });
        document.getElementById('print-container').innerHTML = html;
        window.print();
    }
</script>
</body>
</html>
